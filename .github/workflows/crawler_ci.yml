name: Crawler CI

on:
  push:
    branches: [ "main", "feature/*" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *' # Daily regression

jobs:
  test:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgJsonGlob: 'vcpkg.json'
        vcpkgGitCommitId: 'e1decf72bc06ea7a7e2d9b53aa28931392254332'
        
    - name: Configure CMake
      shell: pwsh
      run: |
        cmake -B build -S . `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_BUILD_TYPE=Release
      
    - name: Build
      run: cmake --build build --config Release
      
    - name: Run Crawler Tests
      run: cd build && ctest -C Release --output-on-failure
      
    - name: Run Data Integrity Check (Mock)
      # This step runs the python script to verify logic on sample URLs (if accessible)
      # or just re-runs the C++ unit tests which use mocks.
      run: build\Release\crawler_tests.exe
