name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to rollback (e.g. v1.2.3)
        type: string
        required: true
      confirm:
        description: Type the tag again to confirm
        type: string
        required: true

permissions:
  contents: write

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Inputs
        shell: bash
        run: |
          tag="${{ inputs.tag }}"
          confirm="${{ inputs.confirm }}"
          if [[ "$tag" != "$confirm" ]]; then
            echo "confirm does not match tag"
            exit 1
          fi
          if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "tag must be vX.Y.Z"
            exit 1
          fi

      - name: Delete GitHub Release (best effort, with retry)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ inputs.tag }}"
          for i in 1 2 3; do
            if gh release delete "$tag" -y; then
              exit 0
            fi
            echo "release delete failed (attempt $i). Retrying..."
            sleep $((i * 5))
          done
          echo "release delete failed after retries"
          exit 1

      - name: Delete Tag Ref (best effort)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ inputs.tag }}"
          gh api -X DELETE "repos/${GITHUB_REPOSITORY}/git/refs/tags/${tag}" || true
